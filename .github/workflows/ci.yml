name: Awade CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Documentation and Validation
  validate:
    name: ðŸ“š Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests fastapi uvicorn pydantic
        
    - name: Run documentation validation
      run: |
        python scripts/update_api_docs.py
        python scripts/mcp_health_check.py --save
        
    - name: Check for required files
      run: |
        test -f README.md
        test -f docs/internal/api-contracts.md
        test -f docs/internal/requirements.md
        test -f docs/api/README.md
        test -f AI_USE_POLICY.md
        echo "âœ… All required documentation files present"
        
    - name: Validate MCP configuration
      run: |
        test -f .cursor/mcp.json
        python -m json.tool .cursor/mcp.json
        echo "âœ… MCP configuration is valid"

  # Backend Testing
  backend-test:
    name: ðŸ”§ Backend Tests
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install backend dependencies
      run: |
        cd apps/backend
        pip install -r requirements.txt
        
    - name: Install contract testing dependencies
      run: |
        pip install jsonschema requests
        
    - name: Run backend tests
      run: |
        cd apps/backend
        python -m pytest tests/ -v || echo "âš ï¸  No tests found yet"
        
    - name: Check API documentation
      run: |
        python scripts/update_api_docs.py
        test -f apps/backend/app/openapi.json || echo "âš ï¸  No API spec generated yet"

  # Frontend Testing (if exists)
  frontend-test:
    name: ðŸŽ¨ Frontend Tests
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: apps/frontend/package-lock.json
        
    - name: Install frontend dependencies
      run: |
        cd apps/frontend
        npm ci || echo "âš ï¸  No package.json found"
        
    - name: Run frontend tests
      run: |
        cd apps/frontend
        npm test || echo "âš ï¸  No tests configured yet"
        
    - name: Build frontend
      run: |
        cd apps/frontend
        npm run build || echo "âš ï¸  No build script found"

  # Contract Testing
  contract-test:
    name: ðŸ“‹ Contract Tests
    runs-on: ubuntu-latest
    needs: [validate, backend-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install contract testing dependencies
      run: |
        pip install jsonschema requests
        
    - name: Start backend server
      run: |
        cd apps/backend
        nohup uvicorn main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        sleep 10
        
    - name: Run contract tests
      run: |
        python scripts/contract_testing.py --base-url http://localhost:8000 --save
        
    - name: Upload contract test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: contract-test-report
        path: logs/contract_test_report.json
        retention-days: 30

  # Security and Quality Checks
  security:
    name: ðŸ”’ Security & Quality
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for sensitive files
      run: |
        if git ls-files | grep -E '\.(env|key|pem|p12)$'; then
          echo "âŒ Sensitive files detected in repository"
          exit 1
        else
          echo "âœ… No sensitive files found"
        fi
        
    - name: Check for hardcoded secrets
      run: |
        if grep -r "password\|secret\|key\|token" --include="*.py" --include="*.js" --include="*.md" . | grep -v "example\|test\|TODO"; then
          echo "âš ï¸  Potential hardcoded secrets found - review manually"
        else
          echo "âœ… No obvious hardcoded secrets found"
        fi
        
    - name: Validate environment template
      run: |
        test -f .env.example
        echo "âœ… Environment template present"

  # Deployment (on main branch only)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [validate, backend-test, frontend-test, contract-test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Generate deployment artifacts
      run: |
        # Create deployment package
        mkdir -p dist
        cp -r apps/backend dist/
        cp -r packages dist/
        cp -r docs dist/
        cp README.md dist/
        cp AI_USE_POLICY.md dist/
        cp LICENSE.md dist/
        cp .env.example dist/
        
        # Generate final health report
        python scripts/mcp_health_check.py --save
        
        echo "âœ… Deployment artifacts created"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: awade-deployment
        path: dist/
        retention-days: 30
        
    - name: Notify deployment
      run: |
        echo "ðŸš€ Awade deployment ready!"
        echo "ðŸ“¦ Artifacts uploaded to GitHub Actions"
        echo "ðŸ“Š Health report: logs/mcp_health.json"

  # Summary and Notifications
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [validate, backend-test, frontend-test, contract-test, security, deploy]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate summary
      run: |
        echo "## ðŸŽ‰ Awade CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Completed Jobs:" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.validate.result }}" == "success" ]; then
          echo "- âœ… Documentation validation" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Documentation validation" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.backend-test.result }}" == "success" ]; then
          echo "- âœ… Backend tests" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Backend tests" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.frontend-test.result }}" == "success" ]; then
          echo "- âœ… Frontend tests" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Frontend tests" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.contract-test.result }}" == "success" ]; then
          echo "- âœ… Contract tests" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Contract tests" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security.result }}" == "success" ]; then
          echo "- âœ… Security checks" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Security checks" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "- âœ… Deployment ready" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review any warnings or failures" >> $GITHUB_STEP_SUMMARY
        echo "2. Check deployment artifacts if available" >> $GITHUB_STEP_SUMMARY
        echo "3. Update documentation if needed" >> $GITHUB_STEP_SUMMARY 